<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenClash管理面板</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: #333;
        }
        .operation-item {
            padding: 8px 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        .operation-success {
            background-color: #e9f7ef;
            border: 1px solid #d6e9c6;
        }
        .operation-error {
            background-color: #fde7e7;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 col-lg-2">
                <div class="sidebar">
                    <h3>OpenClash管理</h3>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showDashboard()">
                                <i class="bi bi-speedometer2"></i> 仪表板
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showNodes()">
                                <i class="bi bi-nodes"></i> 节点管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showNodeList()">
                                <i class="bi bi-list-task"></i> 节点列表
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showLogs()">
                                <i class="bi bi-journal-text"></i> 日志查看
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showOperations()">
                                <i class="bi bi-clock-history"></i> 操作历史
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-md-9 col-lg-10">
                <div class="page-content">
                    <h1 id="page-title">仪表板</h1>
                    <div id="dashboard-content">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">系统状态</h5>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>守护进程状态:</strong> <span id="watchdog-status">未知</span></p>
                                        <p><strong>OpenClash状态:</strong> <span id="openclash-status">未知</span></p>
                                        <p><strong>节点数量:</strong> <span id="nodes-count">0</span></p>
                                        <p><strong>最后同步:</strong> <span id="last-sync">未知</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">操作</h5>
                                    </div>
                                    <div class="card-body">
                                        <button type="button" class="btn btn-info" onclick="manualSync()">
                                            <i class="bi bi-arrow-repeat"></i> 立即同步节点
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 节点管理 -->
                    <div id="nodes-content" style="display:none;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">节点管理</h5>
                            </div>
                            <div class="card-body">
                                <textarea id="nodes-textarea" class="form-control" rows="12"></textarea>
                                <div class="mt-3">
                                    <button class="btn btn-success" onclick="saveNodes()">
                                        <i class="bi bi-save"></i> 保存节点
                                    </button>
                                    <button class="btn btn-secondary" onclick="loadNodes()">
                                        <i class="bi bi-arrow-clockwise"></i> 重新加载
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 节点列表 -->
                    <div id="nodelist-content" style="display:none;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">节点列表</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>序号</th>
                                            <th>名称</th>
                                            <th>类型</th>
                                            <th>服务器</th>
                                            <th>端口</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="node-table-body">
                                        <!-- 节点列表内容 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 日志查看 -->
                    <div id="logs-content" style="display:none;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">日志查看</h5>
                            </div>
                            <div class="card-body">
                                <div class="log-container" id="log-container"></div>
                                <button class="btn btn-secondary mt-2" onclick="loadLogs()">
                                    <i class="bi bi-arrow-clockwise"></i> 刷新日志
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 操作历史 -->
                    <div id="operations-content" style="display:none;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">操作历史</h5>
                            </div>
                            <div class="card-body" id="operations-list">
                                <!-- 操作历史内容 -->
                            </div>
                        </div>
                    </div>

                    <!-- 在节点列表后添加策略组管理 -->
                    <div id="proxy-groups-content" style="display:none;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">策略组管理</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <button class="btn btn-primary btn-sm" onclick="loadProxyGroups()">
                                        <i class="bi bi-arrow-clockwise"></i> 刷新策略组
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="proxy-groups-table">
                                        <thead>
                                            <tr>
                                                <th>名称</th>
                                                <th>类型</th>
                                                <th>节点数量</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="proxy-groups-body">
                                            <!-- 策略组数据填充 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
function showDashboard() {
    document.getElementById('dashboard-content').style.display = '';
    document.getElementById('nodes-content').style.display = 'none';
    document.getElementById('nodelist-content').style.display = 'none';
    document.getElementById('logs-content').style.display = 'none';
    document.getElementById('operations-content').style.display = 'none';
    document.getElementById('proxy-groups-content').style.display = 'none'; // 隐藏策略组管理
    document.getElementById('page-title').innerText = '仪表板';
    refreshStatus();
}

function showNodes() {
    document.getElementById('dashboard-content').style.display = 'none';
    document.getElementById('nodes-content').style.display = '';
    document.getElementById('nodelist-content').style.display = 'none';
    document.getElementById('logs-content').style.display = 'none';
    document.getElementById('operations-content').style.display = 'none';
    document.getElementById('proxy-groups-content').style.display = 'none'; // 隐藏策略组管理
    document.getElementById('page-title').innerText = '节点管理';
    loadNodes();
}

function showNodeList() {
    document.getElementById('dashboard-content').style.display = 'none';
    document.getElementById('nodes-content').style.display = 'none';
    document.getElementById('nodelist-content').style.display = '';
    document.getElementById('logs-content').style.display = 'none';
    document.getElementById('operations-content').style.display = 'none';
    document.getElementById('proxy-groups-content').style.display = 'none'; // 隐藏策略组管理
    document.getElementById('page-title').innerText = '节点列表';
    loadNodeList();
}

function showLogs() {
    document.getElementById('dashboard-content').style.display = 'none';
    document.getElementById('nodes-content').style.display = 'none';
    document.getElementById('nodelist-content').style.display = 'none';
    document.getElementById('logs-content').style.display = '';
    document.getElementById('operations-content').style.display = 'none';
    document.getElementById('proxy-groups-content').style.display = 'none'; // 隐藏策略组管理
    document.getElementById('page-title').innerText = '日志查看';
    loadLogs();
}

function showOperations() {
    document.getElementById('dashboard-content').style.display = 'none';
    document.getElementById('nodes-content').style.display = 'none';
    document.getElementById('nodelist-content').style.display = 'none';
    document.getElementById('logs-content').style.display = 'none';
    document.getElementById('operations-content').style.display = '';
    document.getElementById('proxy-groups-content').style.display = 'none'; // 隐藏策略组管理
    document.getElementById('page-title').innerText = '操作历史';
    loadOperations();
}

function showProxyGroups() {
    document.getElementById('dashboard-content').style.display = 'none';
    document.getElementById('nodes-content').style.display = 'none';
    document.getElementById('nodelist-content').style.display = 'none';
    document.getElementById('logs-content').style.display = 'none';
    document.getElementById('operations-content').style.display = 'none';
    document.getElementById('proxy-groups-content').style.display = '';
    document.getElementById('page-title').innerText = '策略组管理';
    loadProxyGroups();
}

function refreshStatus() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            document.getElementById('watchdog-status').innerText = data.watchdog_running ? '运行中' : '未运行';
            document.getElementById('openclash-status').innerText = data.openclash_running ? '运行中' : '未运行';
            document.getElementById('nodes-count').innerText = data.nodes_count + ' 个';
            document.getElementById('last-sync').innerText = data.last_sync;
        })
        .catch(error => {
            console.error('获取状态失败:', error);
        });
}

function loadNodes() {
    fetch('/api/nodes')
        .then(response => response.json())
        .then(data => {
            document.getElementById('nodes-textarea').value = data.content || '';
        })
        .catch(error => {
            console.error('加载节点失败:', error);
        });
}

function saveNodes() {
    let content = document.getElementById('nodes-textarea').value;
    fetch('/api/nodes', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({content})
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if(data.status === 'success') {
            loadNodes();
        }
    })
    .catch(error => {
        console.error('保存节点失败:', error);
        alert('保存失败: ' + error);
    });
}

function loadLogs() {
    fetch('/api/logs')
        .then(response => response.json())
        .then(data => {
            let logs = data.logs || [];
            let html = logs.map(line => line.replace(/</g,'&lt;').replace(/>/g,'&gt;')).join('<br>');
            document.getElementById('log-container').innerHTML = html;
        })
        .catch(error => {
            console.error('加载日志失败:', error);
        });
}

function manualSync() {
    if(!confirm('确定要立即同步节点并重启OpenClash吗？')) return;
    
    fetch('/api/sync', {method:'POST'})
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            refreshStatus();
            loadLogs();
        })
        .catch(error => {
            console.error('同步失败:', error);
            alert('同步失败: ' + error);
        });
}

function loadNodeList() {
    fetch('/api/parse_nodes')
        .then(response => response.json())
        .then(data => {
            let nodes = data.nodes || [];
            let html = nodes.map((node, idx) => {
                return `<tr>
                    <td>${idx+1}</td>
                    <td>${node.name || ''}</td>
                    <td><span class="badge bg-info">${node.type || ''}</span></td>
                    <td>${node.server || ''}</td>
                    <td>${node.port || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editNode(${idx})"><i class="bi bi-pencil"></i> 编辑</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteNode(${idx})"><i class="bi bi-trash"></i> 删除</button>
                    </td>
                </tr>`;
            }).join('');
            document.getElementById('node-table-body').innerHTML = html;
        })
        .catch(error => {
            console.error('加载节点列表失败:', error);
        });
}

function loadProxyGroups() {
    fetch('/api/proxy_groups')
        .then(response => response.json())
        .then(data => {
            let groups = data.groups || [];
            let html = groups.map(group => {
                let proxies = group.proxies || [];
                return `<tr>
                    <td>${group.name || ''}</td>
                    <td><span class="badge bg-info">${group.type || ''}</span></td>
                    <td>${proxies.length}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editProxyGroup('${group.name}')">
                            <i class="bi bi-pencil"></i> 编辑
                        </button>
                    </td>
                </tr>`;
            }).join('');
            document.getElementById('proxy-groups-body').innerHTML = html;
        })
        .catch(error => {
            console.error('加载策略组失败:', error);
        });
}

function editProxyGroup(groupName) {
    alert('编辑策略组功能待实现');
    // 实际实现需要调用后端接口，例如：
    // fetch(`/api/proxy_groups/${groupName}`, { method: 'PUT', headers: {'Content-Type': 'application/json'} })
    //     .then(response => response.json())
    //     .then(data => {
    //         alert(data.message);
    //         loadProxyGroups(); // 刷新列表
    //     })
    //     .catch(error => {
    //         console.error('编辑策略组失败:', error);
    //         alert('编辑策略组失败: ' + error);
    //     });
}

function deleteProxyGroup(groupName) {
    if (!confirm(`确定要删除策略组 "${groupName}" 吗？`)) return;
    fetch(`/api/proxy_groups/${groupName}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            loadProxyGroups(); // 刷新列表
        })
        .catch(error => {
            console.error('删除策略组失败:', error);
            alert('删除策略组失败: ' + error);
        });
}

function loadOperations() {
    fetch('/api/operations')
        .then(response => response.json())
        .then(data => {
            let ops = data.operations || [];
            let html = ops.map(op => {
                let cls = op.status === 'success' ? 'operation-item operation-success' : 'operation-item operation-error';
                return `<div class="${cls}">
                    <b>${op.operation}</b> [${op.status}]<br>
                    <span>${op.message}</span><br>
                    <small class="text-muted">${op.timestamp}</small>
                </div>`;
            }).join('');
            document.getElementById('operations-list').innerHTML = html;
        })
        .catch(error => {
            console.error('加载操作历史失败:', error);
        });
}

// 页面加载完成后自动显示仪表板
document.addEventListener('DOMContentLoaded', function() {
    showDashboard();
});
</script>
</body>
</html> 